<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <title>后台管理</title>
    <link rel="stylesheet" type="text/css" href="css/common.css" />
    <link rel="stylesheet" type="text/css" href="css/main.css" />
</head>

<body>
    <div class="topbar-wrap white">
        <div class="topbar-inner clearfix">
            <div class="topbar-logo-wrap clearfix">
                <h1 class="topbar-logo">BackendManagement</h1>
            </div>
            <div class="top-info-wrap">
                <ul class="top-info-list clearfix">
                    <li><a href="#">manager</a></li>
                    <li><a href="#">LOG OUT</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="container clearfix">
        <div class="sidebar-wrap">
            <div class="sidebar-title">
                <h1>MENU</h1>
            </div>
            <div class="sidebar-content">
                <ul class="sidebar-list">
                    <li>
                        <a href="#"><i class="icon-font">&#xe003;</i>FUNDRAISER</a>
                        <ul class="sub-menu">
                            <li><a style="color: cornflowerblue;" href="insert.html"><i
                                        class="icon-font">&#xe005;</i>ADD</a></li>
                            <li><a href="fundraiser.html"><i class="icon-font">&#xe005;</i>DATALIST</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
        <div class="main-wrap">
            <div class="crumb-wrap">
                <div class="crumb-list"><i class="icon-font"></i><a href="#">FUNDRAISER</a><span
                        class="crumb-step">&gt;</span><a class="crumb-name" href="#">ADD</a></div>
            </div>
            <div class="result-wrap">
                <div class="result-content">
                    <form id="myform">
                        <table class="insert-tab" width="100%">
                            <tbody>
                                <tr>
                                    <th><i class="require-red">*</i>CAPTION</th>
                                    <td>
                                        <input class="required" style="width: calc(100% - 7px);height: 25px;" id="CAPTION" name="title"
                                            size="50" value="" type="text">
                                    </td>
                                </tr>
                                <tr>
                                    <th><i class="require-red">*</i>ORGANIZER</th>
                                    <td><input class="required" style="width: calc(100% - 7px);height: 25px;" id="ORGANIZER" size="50" value=""
                                            type="text"></td>
                                </tr>
                                <tr>
                                    <th width="120"><i class="require-red">*</i>CATEGORY</th>
                                    <td>
                                        <select style="width: 100%;height: 30px;" name="colId" id="category_select" class="required" value=""></select>
                                    </td>
                                </tr>
                                <tr>
                                    <th><i class="require-red">*</i>CITY</th>
                                    <td><input class="required" style="width: calc(100% - 7px);height: 25px;" id="CITY" size="50" value=""
                                            type="text"></td>
                                </tr>
                                <tr>
                                    <th><i class="require-red">*</i>STATUS</th>
                                    <td>
                                        <select style="width: 100%;height: 30px;" id="STATUS" class="required">
                                            <option value="">请选择</option>
                                            <option value="1">ACTIVE</option>
                                            <option value="2">SUSPENDED</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <th><i class="require-red">*</i>TARGET</th>
                                    <td><input class="required" style="width: calc(100% - 7px);height: 25px;" id="TARGET" size="50" value=""
                                            type="number"></td>
                                </tr>
                                <tr>
                                    <th>DESCRIBE</th>
                                    <td><textarea name="content" class="common-textarea" style="width: calc(100% - 7px);" id="DESCRIBE"
                                            cols="30" style="width: 98%;" rows="10"></textarea></td>
                                </tr>
                                <tr>
                                    <th><i class="require-red">*</i>THUMBNAIL</th>
                                    <td>
                                        <input type="file" id="file-input" multiple="true" name="image">
                                        <br><br>
                                        <img style="height: 100px;" id="preview" src="#" alt="">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script>
        const fileInput = document.querySelector('#file-input');
        const preview = document.querySelector('#preview');
        let fundraiser_id;

        window.onload = function () {
            getId()
            getCategory();
            setupFileUpload();
        };

        function getId() {
            var url = location.search;
            if (url.indexOf("?") != -1) {
                var text = url.substr(1);
                ids = text.split("=");
                getDetail(ids[1])
            }
        }
        function getDetail(id) {
            fundraiser_id = id
            const CAPTION = document.querySelector('#CAPTION')
            const ORGANIZER = document.querySelector('#ORGANIZER')
            const category = document.querySelector('#category_select')
            const CITY = document.querySelector('#CITY')
            const STATUS = document.querySelector('#STATUS')
            const TARGET = document.querySelector('#TARGET')
            const IMAGE = document.querySelector('#preview')
            const DESCRIBE = document.querySelector('#DESCRIBE')
            fetch('http://localhost:8085/fundraiser/' + id).then(res => {
                return res.json()
            }).then(response => {
                var data = response.data[0]
                CAPTION.value = data.CAPTION
                ORGANIZER.value = data.ORGANIZER
                category.value = data.CATEGORY_ID
                CITY.value = data.CITY
                STATUS.value = data.ACTIVE
                TARGET.value = data.TARGET_FUNDING
                IMAGE.src = data.URL
                DESCRIBE.value = data.DESCRIBE
            })
        }

        function setupFileUpload() {
            fileInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    }
                    reader.readAsDataURL(file);
                    uploadImage(file);
                }
            });
        }

        function uploadImage() {
            const file = fileInput.files[0];
            if (file) {
                const formData = new FormData();
                formData.append('image', file);
                fetch('http://localhost:8085/uploadImage', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        const postForm = {
                            caption: document.querySelector('#CAPTION').value,
                            organizer: document.querySelector('#ORGANIZER').value,
                            category: document.querySelector('#category_select').value,
                            city: document.querySelector('#CITY').value,
                            status: document.querySelector('#STATUS').value,
                            target: document.querySelector('#TARGET').value,
                            describe: document.querySelector('#DESCRIBE').value,
                            url: data.data
                        }
                        if (fundraiser_id) {
                            postForm.id = fundraiser_id
                            fetch('http://localhost:8085/updateFunfraiser', {
                                method: 'PUT',
                                body: JSON.stringify(postForm),
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            })
                                .then(response => response.json())
                                .then(data => {
                                    console.log('success');
                                })
                        } else {
                            fetch('http://localhost:8085/addFunfraiser', {
                                method: 'POST',
                                body: JSON.stringify(postForm),
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            })
                                .then(response => response.json())
                                .then(data => {
                                    console.log('success');
                                })
                        }
                        alert('UPLOAD SUCCESS!')
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });
            } else {
                alert('Please select an image first.');
            }
        }

        function getCategory() {
            fetch('http://localhost:8085/category').then(res => {
                return res.json()
            }).then(response => {
                const list = document.querySelector('#category_select')
                let text = `<option value="">All</option>`
                response.data.forEach(item => {
                    text += `<option value="` + item.CATEGORY_ID + `">` + item.NAME + `</option>`
                })
                list.innerHTML = text
            })
        }
    </script>
</body>

</html>